name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.3.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew build --no-daemon
      
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        # Rituals v${{ steps.get_version.outputs.VERSION }}
        
        ## üîÆ What's New
        
        <!-- Add release notes here -->
        
        ## üì¶ Installation
        
        ### For Fabric Mod Users
        1. Download `rituals-${{ steps.get_version.outputs.VERSION }}.jar`
        2. Place in your `.minecraft/mods` folder
        3. Requires Fabric Loader 0.15.11+ and Fabric API
        
        ### For Datapack Users
        1. Download `rituals-datapack-${{ steps.get_version.outputs.VERSION }}.zip`
        2. Place in your world's `datapacks` folder
        3. Optionally download the resourcepack for custom textures
        
        ## üìö Documentation
        
        - [Full Documentation](https://github.com/strixun/rituals/blob/main/docs/README.md)
        - [Installation Guide](https://github.com/strixun/rituals/blob/main/docs/INSTALLATION.md)
        - [Fire Sacrifice Guide](https://github.com/strixun/rituals/blob/main/docs/FIRE_SACRIFICE_GUIDE.md)
        
        ## ‚öôÔ∏è Compatibility
        
        - **Minecraft**: 1.21.10
        - **Fabric Loader**: 0.17.3+
        - **Fabric API**: 0.136.0+1.21.10
        - **Java**: 21+
        
        ## üêõ Known Issues
        
        <!-- List any known issues -->
        
        ## üí¨ Support
        
        - [Report Issues](https://github.com/strixun/rituals/issues)
        - [Join Discussions](https://github.com/strixun/rituals/discussions)
        - [Watch on Twitch](https://www.twitch.tv/strixun)
        EOF
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.VERSION }}
        name: Rituals v${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.md
        draft: true
        prerelease: false
        files: |
          build/libs/rituals-*.jar
          build/datapacks/rituals-datapack-*.zip
          build/resourcepacks/rituals-resourcepack-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Release Summary
      run: |
        echo "## üéâ Release Created!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Fabric Mod" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Datapack" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Resourcepack" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚ö†Ô∏è **Note**: Release is created as DRAFT. Review and publish manually." >> $GITHUB_STEP_SUMMARY

